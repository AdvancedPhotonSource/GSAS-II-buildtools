# Compile the GSAS-II binary files on Linux using scons and then upload
# them to the releases area. Uses outputs capability to move the
# output name between steps.

name: Compile Linux w/Meson
description: compile GSAS-II binaries on Linux using newer 

outputs:
  tar-file:
    description: "tar file generated by script"
    value: ${{ steps.compile-step.outputs.tarname }}

runs:
  using: "composite"
  steps:
      - name: compile with scons
        id: compile-step
        shell: bash -l {0}
        run: |
          cd _gsas2
          echo "Linux build"
          mkdir ./tmp
          mkdir ./tmp/outfiles
          meson setup ./tmp/meson_build
          meson compile -C ./tmp/meson_build
          #ls -lR ./tmp
          #ls -l ./tmp/meson_build/sources/*.so
          #ls -l ./tmp/meson_build/sources/*/*.so
          #ls -l ./tmp/meson_build/sources/LATTIC
          #ls -l ./tmp/meson_build/sources/convcell
          cp -l ./tmp/meson_build/sources/*.so ./tmp/outfiles/
          cp -l ./tmp/meson_build/sources/*/*.so ./tmp/outfiles/
          cp -l ./tmp/meson_build/sources/LATTIC ./tmp/outfiles/
          cp -l ./tmp/meson_build/sources/convcell ./tmp/outfiles/
          ls -l ./tmp/outfiles/
          
          # document build  
          echo "Built from G2 version `git log HEAD --oneline | head -1`" >> ./tmp/outfiles/Build.notes.txt
          conda list -f python | tail -1 >> ./tmp/outfiles/Build.notes.txt
          conda list -f numpy | tail -1 >> ./tmp/outfiles/Build.notes.txt
          echo "Using gfortran, info follows" >> ./tmp/outfiles/Build.notes.txt
          gfortran -v 2>> ./tmp/outfiles/Build.notes.txt
          echo "### Dependencies" >> ./tmp/outfiles/Build.notes.txt
          ldd ./tmp/outfiles/*.so >> ./tmp/outfiles/Build.notes.txt
          ldd ./tmp/outfiles/LATTIC >> ./tmp/outfiles/Build.notes.txt
          ldd ./tmp/outfiles/convcell >> ./tmp/outfiles/Build.notes.txt
          cp -l ./tmp/outfiles/Build.notes.txt ./Build.notes.txt

          pwd
          ls -l
          
          # copy needed .so files
          python compile/linuxLibs.py ./tmp/outfiles/

          conda list python
          conda list numpy

          # create tar file with binaries
          #cd ../AllBinaries/$newdir
          #TMPDIR=/tmp/
          #TARFILE=${TMPDIR}${newdir}.tgz
          #echo "tarname=$(echo $TARFILE)" >> $GITHUB_OUTPUT
          #echo "tarname=$(echo $TARFILE)"
          #echo creating $TARFILE
          #tar cvzf $TARFILE *

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.compile-step.outputs.tarname }}
          tag_name: v1.0.1
